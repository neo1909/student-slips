<?xml version = "1.0" encoding = "UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="BankStatementsArchiveDao">

    <update id="updateBankStatementArchive" parameterType="com.studentslips.entities.BankStatement">
        UPDATE PS_Bank_Statement SET
        reference_no = #{referenceNo},
        update_id = #{updateId}, update_date = SYSDATE()
        WHERE ID = #{id}
        <if test="schoolId!=0 ">
        AND school_id=#{schoolId}
        </if>
    </update>

    <select id="selectBankStatementArchive" parameterType="com.studentslips.entities.BankStatementArchiveSearch" resultMap="resultAll">
        Select XX.file_name,XX.bank_statement_date,XX.no_of_bank_statement,XX.balance,XX.no_of_changes,sum(XX.is_hight_light_tmp) as is_hight_light
        from (
        SELECT BS.*,(select count(1) from PS_Students_Debts SD where SD.reference_no=BS.reference_no
        <if test="schoolId!=0 ">
            AND BS.school_id=#{schoolId}
        </if> ) as is_hight_light_tmp
        FROM PS_Bank_Statement BS
        where
        BS.bank_statement_date between #{fromDate} and  #{toDate}
        AND BS.del_yn='N'
        AND BS.post_payment_yn = 'Y'
        <if test="schoolId!=0 ">
            AND BS.school_id=#{schoolId}
        </if>
         ) XX
        group by XX.file_name,XX.bank_statement_date,XX.no_of_bank_statement,XX.balance,XX.no_of_changes
    </select>

    <select id="selectBankStatementArchiveById" parameterType="com.studentslips.entities.BankStatementArchiveSearch" resultMap="result">
        SELECT BS.id,BS.payer_account,BS.payer,BS.purpose,BS.reference_no,BS.claims as amount,(select count(1) from PS_Students_Debts SD where SD.reference_no=BS.reference_no
        <if test="schoolId!=0 ">
            AND BS.school_id=#{schoolId}
        </if> ) as is_hight_light
        FROM PS_Bank_Statement BS
        where BS.file_name = #{filename}
          AND BS.bank_statement_date= #{bankStatementDate}
          AND BS.del_yn='N'
          AND BS.post_payment_yn = 'Y'
        <if test="schoolId!=0 ">
            AND BS.school_id=#{schoolId}
        </if>
    </select>
    <resultMap id = "resultAll" type = "com.studentslips.entities.BankStatement">
        <result property = "filename" column = "file_name"/>
        <result property = "bankStatementDate" column = "bank_statement_date"/>
        <result property = "noOfChanges" column = "no_of_changes"/>
        <result property = "balance" column = "balance"/>
        <result property = "noOfBankStatement" column = "no_of_bank_statement"/>
        <result property = "claims" column = "claims"/>
        <result property = "referenceNo" column = "reference_no"/>
        <result property = "currencyDate" column = "currency_date"/>
        <result property = "insertDate" column = "insert_date"/>
        <result property = "insertId" column = "insert_id"/>
        <result property = "updateDate" column = "update_date"/>
        <result property = "updateId" column = "update_id"/>
        <result property = "postPaymentYn" column = "post_payment_yn"/>
        <result property = "delYn" column = "del_yn"/>
        <result property = "payerAccount" column = "payer_account"/>
        <result property = "isHightLight" column = "is_hight_light"/>
    </resultMap>
    <resultMap id = "result" type = "com.studentslips.entities.BankStatement">
        <result property = "id" column = "id"/>
        <result property = "payer" column = "payer"/>
        <result property = "purpose" column = "purpose"/>
        <result property = "referenceNo" column = "reference_no"/>
        <result property = "claims" column = "amount"/>
        <result property = "isHightLight" column = "is_hight_light"/>
    </resultMap>
</mapper>