<?xml version = "1.0" encoding = "UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="SupplierDao">
    <insert id="insertSupplier" parameterType="com.studentslips.entities.Supplier"  useGeneratedKeys="true" keyProperty="id">
        INSERT INTO onetouch.PS_Suppliers (NAME, school_id, del_yn, insert_date, insert_id)
        VALUES (#{name}, #{schoolId}, 'N', SYSDATE(), #{insertId});
    </insert>
    <insert id="insertSupplierService" parameterType="com.studentslips.entities.SupplierServiceDetail" useGeneratedKeys="true" keyProperty="id" keyColumn="id">
        INSERT INTO onetouch.PS_Suppliers_Service ( name, suppliers_id, service_id,school_id,price,no_payment,amount_1,amount_2,amount_3,amount_4,amount_5,
                                                   amount_6,amount_7,amount_8,amount_9,amount_10,amount_11,amount_12,grade,del_yn, insert_date, insert_id, group_id )
        VALUES (#{name}, #{supplierId}, #{serviceId},#{schoolId},#{price},#{noPayment},#{amount1},#{amount2},#{amount3},#{amount4},#{amount5},#{amount6},#{amount7},
                #{amount8},#{amount9},#{amount10},#{amount11},#{amount12},#{grade},'N', SYSDATE(), #{insertId}, #{groupId});
    </insert>
    <update id="updateSupplier" parameterType="com.studentslips.entities.Supplier">
        UPDATE onetouch.PS_Suppliers  SET
        <if test="name!= null and name != ''">
            NAME = #{name},
        </if>
        update_id = #{updateId}, update_date = SYSDATE() WHERE ID = #{id}
        <if test="schoolId!=0 ">
            AND  school_id = #{schoolId}
        </if>
    </update>
    <update id="updateSupplierService" parameterType="com.studentslips.entities.SupplierServiceDetail">
        UPDATE onetouch.PS_Suppliers_Service  SET
        <if test="name!= null and name!=''">
            NAME = #{name},
        </if>
        <if test="serviceId != 0 ">
        service_id=#{serviceId},
        </if>
        <if test="supplierId != 0 ">
            suppliers_id=#{supplierId},
        </if>
        <if test="price!= 0 ">
            price=#{price},
        </if>
        <if test="noPayment!= 0 ">
            no_payment=#{noPayment},
        </if>
        <if test="amount1!= 0 ">
            amount_1=#{amount1},
        </if>
        <if test="amount2!= 0 ">
            amount_2=#{amount2},
        </if>
        <if test="amount3!= 0 ">
            amount_3=#{amount3},
        </if>
        <if test="amount4!= 0 ">
            amount_4=#{amount4},
        </if>
        <if test="amount5!= 0 ">
            amount_5=#{amount5},
        </if>
        <if test="amount6!= 0 ">
            amount_6=#{amount6},
        </if>
        <if test="amount7!= 0 ">
            amount_7=#{amount7},
        </if>
        <if test="amount8!= 0 ">
            amount_8=#{amount8},
        </if>
        <if test="amount9!= 0 ">
            amount_9=#{amount9},
        </if>
        <if test="amount10!= 0 ">
            amount_10=#{amount10},
        </if>
        <if test="amount11!= 0 ">
            amount_11=#{amount11},
        </if>
        <if test="amount12!= 0 ">
            amount_12=#{amount12},
        </if>
        update_id = #{updateId}
        , update_date = SYSDATE()

        WHERE 1=1
        <if test="schoolId!=0 ">
            AND  school_id = #{schoolId}
        </if>
        <if test="groupId != 0 ">
            AND  group_id = #{groupId}
        </if>
        <if test="grade != 0">
            AND grade=#{grade},
        </if>
        <if test="id != 0 ">
            AND  id = #{id}
        </if>
    </update>
    <delete id="deleteSupplier" parameterType="com.studentslips.entities.Supplier">
        UPDATE onetouch.PS_Suppliers  SET  del_yn = 'Y',update_id = #{updateId}, update_date = SYSDATE()
        WHERE ID = #{id} AND del_yn = 'N';
    </delete>
    <delete id="deleteSupplierService" parameterType="com.studentslips.entities.SupplierServiceDetail">
        DELETE FROM onetouch.PS_Suppliers_Service
        WHERE 1=1
        <if test="groupId != 0 ">
            AND  group_id = #{groupId}
        </if>
        <if test="grade != 0 ">
            AND  grade = #{grade}
        </if>
        <if test="id != 0 ">
            AND  id = #{id}
        </if>
    </delete>
    <select id="selectSupplierDetail" parameterType="com.studentslips.entities.SupplierServiceDetail"  resultMap="result">

        select
            pss.id,
            pss.name,
            pss.suppliers_id,
            pss.service_id,
            pss.school_id,
            pss.price,
            pss.no_payment,
            pss.grade,
            pss.amount_1,
            pss.amount_2,
            pss.amount_3,
            pss.amount_4,
            pss.amount_5,
            pss.amount_6,
            pss.amount_7,
            pss.amount_8,
            pss.amount_9,
            pss.amount_10,
            pss.amount_11,
            pss.amount_12,

            ps.name as supplier_name,
            ps2.name as service_name

        from PS_Suppliers_Service pss
        left join PS_Suppliers ps on ps.id = pss.suppliers_id
        left join PS_Service ps2 on ps2.id = pss.service_id

        where pss.del_yn = 'N'
        <if test="id != 0">
          AND pss.id = #{id}
        </if>
        <if test="schoolId != 0">
          and pss.school_id = #{schoolId}
        </if>
        <if test="name != null and name != ''">
            <bind name="nameLike" value="'%' + name + '%'" />
            and   UPPER(pss.name) like UPPER(#{nameLike})
        </if>
        <if test="grade != 0">
          and pss.grade = #{grade}
        </if>
    </select>
    <select id="selectAllSupplier" parameterType="com.studentslips.entities.Supplier"  resultMap="resultSupplier">
        SELECT S.id,S.name,S.school_id, (Select name from PS_School SL where S.school_id=SL.id AND del_yn='N') AS schoolName
        ,S.insert_date,S.insert_id,S.update_date,S.update_id,S.del_yn
        FROM onetouch.PS_Suppliers S
        where S.del_yn='N'
        <if test="name !=null and name !=''">
            <bind name="nameLike" value="'%' + name + '%'" />
            AND   UPPER(S.name) like UPPER(#{nameLike})
        </if>
        <if test="schoolId != 0">
            AND S.school_id=#{schoolId}
        </if>
    </select>
    <select id="selectSupplierById" parameterType="int"  resultMap="resultSupplier">
        SELECT S.id,S.name,S.school_id, (Select name from PS_School SL where S.school_id=SL.id AND del_yn='N') AS schoolName
        ,S.insert_date,S.insert_id,S.update_date,S.update_id,S.del_yn
        FROM onetouch.PS_Suppliers S
        where S.del_yn='N' and S.id =#{id}
    </select>

    <resultMap id = "resultSupplier" type = "com.studentslips.entities.Supplier">
        <result property = "id" column = "id"/>
        <result property = "name" column = "name"/>
        <result property = "schoolName" column = "schoolName"/>
        <result property = "schoolId" column = "school_id"/>
        <result property = "delYn" column = "del_yn"/>
        <result property = "insertId" column = "insert_id"/>
        <result property = "insertDate" column = "insert_date"/>
        <result property = "updateId" column = "update_id"/>
        <result property = "updateDate" column = "update_date"/>
    </resultMap>

    <resultMap id = "result" type = "com.studentslips.entities.SupplierServiceDetail">
        <result property = "id" column = "id"/>
        <result property = "name" column = "name"/>

        <result property = "supplierId" column = "suppliers_id"/>
        <result property = "supplierName" column = "supplier_name"/>

        <result property = "serviceId" column = "service_id"/>
        <result property = "serviceName" column = "service_name"/>

        <result property = "schoolId" column = "school_id"/>
        <result property = "grade" column = "grade"/>
        <result property = "price" column = "price"/>
        <result property = "noPayment" column = "no_payment"/>

        <result property = "amount1" column = "amount_1"/>
        <result property = "amount2" column = "amount_2"/>
        <result property = "amount3" column = "amount_3"/>
        <result property = "amount4" column = "amount_4"/>
        <result property = "amount5" column = "amount_5"/>
        <result property = "amount6" column = "amount_6"/>
        <result property = "amount7" column = "amount_7"/>
        <result property = "amount8" column = "amount_8"/>
        <result property = "amount9" column = "amount_9"/>
        <result property = "amount10" column = "amount_10"/>
        <result property = "amount11" column = "amount_11"/>
        <result property = "amount12" column = "amount_12"/>

    </resultMap>
    
    <insert id="insertSupplierServiceGroup" parameterType="com.studentslips.entities.SupplierServiceDetailGroup" useGeneratedKeys="true" keyProperty="groupId" keyColumn="id">
        INSERT INTO onetouch.PS_Suppliers_Service_Group ( name, school_id, del_yn, insert_date, insert_id )
        VALUES (#{name}, ${schoolId}, 'N', SYSDATE(), #{insertId});
    </insert>
    
    <update id="updateSupplierServiceGroup" parameterType="com.studentslips.entities.SupplierServiceDetailGroup">
        UPDATE onetouch.PS_Suppliers_Service_Group  SET
        <if test="name!= null and name != ''">
            NAME = #{name},
        </if>
        update_id = #{updateId}, update_date = SYSDATE() WHERE ID = #{groupId}
        <if test="schoolId!=0 ">
            AND  school_id = #{schoolId}
        </if>
    </update>
    
    <select id="getAllSupplierServiceGroups" parameterType="com.studentslips.entities.SupplierServiceDetail"  resultMap="supSvcDtlGroupSearchModel">
        select
			SS.*, S01.list_grade_ids_str, ps.name as supplier_name, ps2.name as service_name
		from ps_suppliers_service SS
		inner join (
			select
				group_id,
				GROUP_CONCAT(grade) as list_grade_ids_str
			from ps_suppliers_service
			group by group_id
		) S01 on SS.group_id = S01.group_id
        left join PS_Suppliers ps on ps.id = SS.suppliers_id
        left join PS_Service ps2 on ps2.id = SS.service_id
        where SS.del_yn = 'N'
        <if test="name !=null and name !=''">
            <bind name="nameLike" value="'%' + name + '%'" />
            AND SS.name like #{nameLike}
        </if>
        group by group_id
    </select>
    
    <resultMap id = "supSvcDtlGroupSearchModel" type = "com.studentslips.entities.SupplierServiceDetailGroup">
        <result property = "groupId" column = "group_id"/>
        <result property = "listGradeIdsStr" column = "list_grade_ids_str"/>
        <result property = "name" column = "name"/>
        <result property = "supplierId" column = "suppliers_id"/>
        <result property = "supplierName" column = "supplier_name"/>
        <result property = "serviceId" column = "service_id"/>
        <result property = "serviceName" column = "service_name"/>
        <result property = "schoolId" column = "school_id"/>
        <result property = "price" column = "price"/>
        <result property = "noPayment" column = "no_payment"/>
        <result property = "amount1" column = "amount_1"/>
        <result property = "amount2" column = "amount_2"/>
        <result property = "amount3" column = "amount_3"/>
        <result property = "amount4" column = "amount_4"/>
        <result property = "amount5" column = "amount_5"/>
        <result property = "amount6" column = "amount_6"/>
        <result property = "amount7" column = "amount_7"/>
        <result property = "amount8" column = "amount_8"/>
        <result property = "amount9" column = "amount_9"/>
        <result property = "amount10" column = "amount_10"/>
        <result property = "amount11" column = "amount_11"/>
        <result property = "amount12" column = "amount_12"/>
    </resultMap>
    
    <select id="getSupplierServiceGroupByGroupId" parameterType="com.studentslips.entities.SupplierServiceDetail"  resultMap="supSvcDtlGroupUpdateModel">
        select
			SS.*, S01.list_grade_ids_str, ps.name as supplier_name, ps2.name as service_name
		from ps_suppliers_service SS
		inner join (
			select
				group_id,
				GROUP_CONCAT(grade) as list_grade_ids_str
			from ps_suppliers_service
			group by group_id
		) S01 on SS.group_id = S01.group_id
        left join PS_Suppliers ps on ps.id = SS.suppliers_id
        left join PS_Service ps2 on ps2.id = SS.service_id
        where SS.del_yn = 'N'
        and SS.group_id = #{groupId}
    </select>
    
    <resultMap id = "supSvcDtlGroupUpdateModel" type = "com.studentslips.entities.SupplierServiceDetailGroup">
        <result property = "groupId" column = "group_id"/>
       	<result property = "listGradeIdsStr" column = "list_grade_ids_str"/>
        <result property = "name" column = "name"/>
        <result property = "supplierId" column = "suppliers_id"/>
        <result property = "supplierName" column = "supplier_name"/>
        <result property = "serviceId" column = "service_id"/>
        <result property = "serviceName" column = "service_name"/>
        <result property = "schoolId" column = "school_id"/>
        <result property = "price" column = "price"/>
        <result property = "noPayment" column = "no_payment"/>
        <result property = "amount1" column = "amount_1"/>
        <result property = "amount2" column = "amount_2"/>
        <result property = "amount3" column = "amount_3"/>
        <result property = "amount4" column = "amount_4"/>
        <result property = "amount5" column = "amount_5"/>
        <result property = "amount6" column = "amount_6"/>
        <result property = "amount7" column = "amount_7"/>
        <result property = "amount8" column = "amount_8"/>
        <result property = "amount9" column = "amount_9"/>
        <result property = "amount10" column = "amount_10"/>
        <result property = "amount11" column = "amount_11"/>
        <result property = "amount12" column = "amount_12"/>
        <collection property="listGradeIds" ofType="java.lang.Integer" javaType="ArrayList">
        	<result column="grade"/>
        </collection>
    </resultMap>
</mapper>