<?xml version = "1.0" encoding = "UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="StudentOverviewBalanceDao">

    <resultMap id="result" type="com.studentslips.entities.StudentOverviewBalanceDTO">
        <result property="studentDebtsId" column="student_debts_id"/>
        <result property="serviceId" column="service_id"/>
        <result property="serviceNm" column="service_nm"/>
        <result property="id" column="student_id"/>
        <result property="date" column="dateA"/>
        <result property="description" column="descriptions"/>
        <result property="debit" column="debit"/>
        <result property="print" column="print"/>
        <result property="claims" column="claims"/>
        <result property="balance" column="balance"/>
        <result property="rowType" column="row_type"/>
    </resultMap>

    <select id="selectStudentOverviewBalance" parameterType="com.studentslips.entities.StudentOverviewBalanceRequestDTO" resultMap="result">
        WITH student_debts as (
            SELECT sd.*, CONCAT((
                                    select name from PS_Service where service_id = sd.service_id and school_id = sd.school_id
                                ), ' - ', MONTHNAME(debit_date) , ' 1/1 ') AS descriptions
            FROM PS_Students_Debts sd
            where student_id = #{id} and sd.service_id = #{serviceId} and del_yn = 'N'
            and school_id = (Select school_id from PS_Students where id = #{seqNo})
                -- and sd.debit_date between '2021-08-10' and  '2021-09-11'
        )

        select T.* from (
                            Select
                                sd.id as student_debts_id,
                                service_id,
                                (SELECT name FROM PS_Service where service_id = sd.service_id and school_id = sd.school_id) as service_nm,
                                student_id,
                                sd.debit_date AS dateA,
                                sd.descriptions,
                                sd.amount_debt AS debit,
                                1 AS print,
                                0 AS claims,
                                0 AS balance,
                                1 AS row_type
                            from student_debts sd

                            UNION

                            SELECT
                                '' as student_debts_id,
                                '' as service_id,
                                '' as service_nm,
                                '' as student_id,
                                bank_statement_date AS dateA,
                                CONCAT('Bank statement ', no_of_bank_statement) AS descriptions,
                                0 AS debit,
                                0 AS print,
                                claims,
                                0 as balance,
                                2 AS row_type
                            FROM PS_Bank_Statement sb
                            WHERE sb.del_yn = 'N' and school_id = (Select school_id from PS_Students where id = #{seqNo}) and  sb.post_payment_yn='Y' and sb.reference_no in (select distinct reference_no from student_debts)
                    --              and sb.bank_statement_date between '2021-08-10' and  '2021-09-11'
                        ) AS T
        Order by T.dateA

    </select>

    <resultMap id="print-result" type="com.studentslips.entities.StudentOverviewBalancePrintDTO">
        <result property="id" column="student_id"/>
        <result property="date" column="debit_date"/>
        <result property="payerInfo" column="payer_info"/>
        <result property="purpose" column="purpose"/>
        <result property="payee" column="payee"/>
        <result property="amount" column="amount"/>
        <result property="payerAcc" column="payer_acc"/>
        <result property="payeeAcc" column="payee_acc"/>
        <result property="payeeAddress" column="payee_address"/>
        <result property="refNo" column="reference_no"/>
    </resultMap>

    <select id="selectPrintData" parameterType="com.studentslips.entities.StudentOverviewBalancePrintDTO" resultMap="print-result">
        SELECT
            sd.student_id as id,
            sd.debit_date as date,
            st.name as payer_info,
            purpose,
            sch.name as payee,
            amount_debt as amount,
            '' as payer_acc,
            sch.bank_account_number as payee_acc,
            sch.address as payee_address,
            reference_no
        FROM onetouch.PS_Students_Debts sd
            LEFT JOIN PS_Students st ON sd.student_id = st.student_id and sd.school_id = st.school_id
            LEFT JOIN PS_School sch ON sch.id = st.school_id
        WHERE sd.student_id = #{id} and debit_date = #{date} and sd.id = #{studentDebtsId} and sd.school_id = #{schoolId}

    </select>


    <select id="selectDistinctServiceStdDebts" parameterType="com.studentslips.entities.StudentOverviewBalanceRequestDTO" resultType="int">
        SELECT distinct service_id FROM PS_Students_Debts where student_id = #{id} and school_id= (Select school_id from PS_Students where id = #{seqNo});
    </select>

</mapper>