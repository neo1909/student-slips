<?xml version = "1.0" encoding = "UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="StudentOverviewBalanceDao">

    <resultMap id="result" type="com.studentslips.entities.StudentOverviewBalanceDTO">
        <result property="serviceId" column="service_id"/>
        <result property="serviceNm" column="service_nm"/>
        <result property="id" column="student_id"/>
        <result property="date" column="dateA"/>
        <result property="description" column="descriptions"/>
        <result property="debit" column="debit"/>
        <result property="print" column="print"/>
        <result property="claims" column="claims"/>
        <result property="balance" column="balance"/>
        <result property="rowType" column="row_type"/>
    </resultMap>

    <select id="selectStudentOverviewBalance" parameterType="com.studentslips.entities.StudentOverviewBalanceRequestDTO" resultMap="result">
        WITH student_debts as (
            SELECT sd.*, CONCAT((
                                    select name from PS_Service where id = sd.service_id
                                ), ' - ', MONTHNAME(debit_date) , ' 1/1 ') AS descriptions
            FROM PS_Students_Debts sd
            where student_id = #{id} and sd.service_id = #{serviceId} and del_yn = 'N'
                -- and sd.debit_date between '2021-08-10' and  '2021-09-11'
        )

        select T.* from (
                            Select
                                service_id,
                                (SELECT name FROM PS_Service where id = service_id) as service_nm,
                                student_id,
                                sd.debit_date AS dateA,
                                sd.descriptions,
                                sd.amount_debt AS debit,
                                1 AS print,
                                0 AS claims,
                                0 AS balance,
                                1 AS row_type
                            from student_debts sd

                            UNION

                            SELECT
                                sd.service_id,
                                (SELECT name FROM PS_Service where id = sd.service_id) as service_nm,
                                student_id,
                                bank_statement_date AS dateA,
                                CONCAT('Bank statement ', no_of_bank_statement) AS descriptions,
                                0 AS debit,
                                0 AS print,
                                claims,
                                0 as balance,
                                2 AS row_type
                            FROM PS_Bank_Statement sb
                                     INNER join student_debts sd on sd.reference_no = sb.reference_no
                            WHERE sb.del_yn = 'N'
                    --              and sb.bank_statement_date between '2021-08-10' and  '2021-09-11'
                        ) AS T
        Order by T.dateA

    </select>

    <resultMap id="print-result" type="com.studentslips.entities.StudentOverviewBalancePrintDTO">
        <result property="id" column="student_id"/>
        <result property="date" column="debit_date"/>
        <result property="payerInfo" column="payer_info"/>
        <result property="purpose" column="purpose"/>
        <result property="payee" column="payee"/>
        <result property="amount" column="amount"/>
        <result property="payerAcc" column="payer_acc"/>
        <result property="payeeAcc" column="payee_acc"/>
        <result property="refNo" column="reference_no"/>
    </resultMap>

    <select id="selectPrintData" parameterType="com.studentslips.entities.StudentOverviewBalancePrintDTO" resultMap="print-result">
        SELECT
            student_id as id,
            debit_date as date,
            (select name from PS_Students where id = #{id}) as payer_info,
            purpose,
            (select sc.name from PS_Students st join PS_School sc on st.school_id = sc.id where st.id = #{id}) as payee,
            amount_debt as amount,
            '1111-222-6886-6789' as payer_acc,
            (select sc.bank_account_number from PS_Students st join PS_School sc on st.school_id = sc.id where st.id = #{id}) as payee_acc,
            reference_no
        FROM onetouch.PS_Students_Debts sd
        WHERE sd.student_id = #{id} and debit_date = #{date}
    </select>


    <select id="selectDistinctServiceStdDebts" parameterType="int" resultType="int">
        SELECT distinct service_id FROM PS_Students_Debts where student_id = 1;
    </select>

</mapper>