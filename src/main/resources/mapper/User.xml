<?xml version = "1.0" encoding = "UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="UserDao">
    <select id="selectUser" parameterType="com.studentslips.entities.User" resultMap="userModel">
        SELECT
	        U.id,
	        U.username,
	        U.email,
	        U.school_id,
	        U.full_name,
	        U.user_type,
	        U.last_login_date,
	        U.status,
	        U.description,
	        U.del_yn,
	        U.insert_date
        FROM PS_Users U
        where 1=1
        	and U.del_yn = 'N'
        <if test="id > 0">
        	and U.id = #{id}
        </if>
        <if test="username != null and username !=''">
        	and U.username = #{username}
        </if>
        <if test="email != null and email !=''">
        	and U.email = #{email}
        </if>
        
    </select>
    
    <select id="searchAllUsers" parameterType="com.studentslips.entities.User" resultMap="userSearchResultModel">
        SELECT
        	row_number() over (order by id asc) as rnum,
	        U.*,
	        S.name as schoolName
        FROM PS_Users U
        inner join PS_School S on U.school_id = S.id
        where 1=1
        	and U.del_yn = 'N'
        <if test="fullName != null and fullName !=''">
            <bind name="nameLike" value="'%' + fullName + '%'" />
         	and U.full_name like #{nameLike}
        </if>
        <if test="username != null and username !=''">
        	and U.username = #{username}
        </if>
        <if test="status != null and status !=''">
        	and U.status = #{status}
        </if>
        <if test="schoolId != null and schoolId !=''">
        	and U.school_id = #{schoolId}
        </if>
        
    </select>

    <insert id="insertUser" parameterType="com.studentslips.entities.User" useGeneratedKeys="true" keyProperty="id">
	    <selectKey resultType="int" keyProperty="id" order="AFTER" >
		  SELECT LAST_INSERT_ID() as id
		</selectKey>
        INSERT INTO PS_Users (username, password, full_name, school_id, email, user_type, login_retry_count, last_login_date, status, description, del_yn, insert_date, insert_id, update_date, update_id)
        VALUES (#{username}, #{password}, #{fullName}, #{schoolId}, #{email}, #{userType}, #{loginRetryCount}, #{lastLoginDate}, #{status}, #{description}, 'N', SYSDATE(), null, null, null);
    </insert>

    <update id="updateUser" parameterType="com.studentslips.entities.User">
        UPDATE PS_Users SET
        <if test="password != null and password !=''">
            password = #{password},
        </if>
        <if test="fullName != null and fullName !=''">
            full_name = #{fullName},
        </if>
        <if test="schoolId != null and schoolId !=''">
            school_id = #{schoolId},
        </if>
        <if test="email != null and email !=''">
            email = #{email},
        </if>
        <if test="userType != null and userType !=''">
            user_type = #{userType},
        </if>
        <if test="loginRetryCount > -1">
            login_retry_count = #{loginRetryCount},
        </if>
        <if test="lastLoginDate != null">
            last_login_date = #{lastLoginDate},
        </if>
        <if test="status != null and status !=''">
            status = #{status},
        </if>
        <if test="description != null and description !=''">
            description = #{description},
        </if>
        <if test="delYn != null and delYn !=''">
            del_yn = #{delYn},
        </if>
        update_id = #{updateId},
        update_date = SYSDATE()
        WHERE id = #{id}
    </update>

    <update id="deleteUserById" parameterType="com.studentslips.entities.User">
        UPDATE PS_Users SET
	        del_yn = 'Y',
	        update_id = #{updateId},
	        update_date = SYSDATE()
        WHERE id = #{id}
    </update>
    
    <select id="selectUserWithRoles" parameterType="com.studentslips.entities.User" resultMap="userWithRolesModel">
        SELECT
        	U.id,
        	U.username,
        	U.password,
        	U.email,
        	U.full_name,
        	U.school_id,
        	U.status,
        	U.last_login_date,
        	U.login_retry_count,
        	R.id as roleId,
        	R.name as roleName
        FROM PS_Users U
        left join PS_User_Role UR on U.id = UR.user_id
        inner join PS_Roles R on UR.role_id = R.id
        where 1=1
        	and U.del_yn = 'N'
        <if test="username != null and username !=''">
        	and U.username = #{username}
        </if>
        <if test="email != null and email !=''">
        	and U.email = #{email}
        </if>
        
    </select>
    
    <resultMap id="userSearchResultModel" type = "com.studentslips.entities.UserSearchResult">
        <result property = "rnum" column = "rnum"/>
        <result property = "id" column = "id"/>
        <result property = "username" column = "username"/>
        <result property = "email" column = "email"/>
        <result property = "schoolId" column = "school_id"/>
        <result property = "schoolName" column = "schoolName"/>
        <result property = "fullName" column = "full_name"/>
        <result property = "userType" column = "user_type"/>
        <result property = "lastLoginDate" column = "last_login_date"/>
        <result property = "status" column = "status"/>
        <result property = "description" column = "description"/>
        <result property = "delYn" column = "del_yn"/>
        <result property = "insertDate" column = "insert_date"/>
    </resultMap>
    
    <resultMap id="userModel" type = "com.studentslips.entities.User">
        <result property = "id" column = "id"/>
        <result property = "username" column = "username"/>
        <result property = "email" column = "email"/>
        <result property = "schoolId" column = "school_id"/>
        <result property = "fullName" column = "full_name"/>
        <result property = "userType" column = "user_type"/>
        <result property = "lastLoginDate" column = "last_login_date"/>
        <result property = "status" column = "status"/>
        <result property = "description" column = "description"/>
        <result property = "delYn" column = "del_yn"/>
        <result property = "insertDate" column = "insert_date"/>
    </resultMap>
    
    <resultMap id="userWithRolesModel" type = "com.studentslips.entities.User">
        <result property = "id" column = "id"/>
        <result property = "username" column = "username"/>
        <result property = "password" column = "password"/>
        <result property = "email" column = "email"/>
        <result property = "fullName" column = "full_name"/>
        <result property = "schoolId" column = "school_id"/>
        <result property = "status" column = "status"/>
        <result property = "lastLoginDate" column = "last_login_date"/>
        <result property = "loginRetryCount" column = "login_retry_count"/>
		<collection property="roles" ofType="com.studentslips.entities.Role">
			<id property="id" column="roleId" />
			<id property="name" column="roleName" />
		</collection>
    </resultMap>
</mapper>